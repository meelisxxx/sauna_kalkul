<script>
    const VAT = 1.24; // Käibemaks 24%
    let electricityPrices = [];
    let currentMode = 'exchange';

    // Aitab oodata (timeout), et fetch ei jääks igavesti rippuma
    const fetchWithTimeout = async (resource, options = {}) => {
        const { timeout = 5000 } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
    };

    // See funktsioon proovib laadida hindu mitmest kohast (3 meetodit)
    async function fetchPrices() {
        document.getElementById('loading').style.display = 'block';
        const select = document.getElementById('startTimeSelect');
        select.innerHTML = '<option>Laen andmeid...</option>';

        const start = new Date();
        start.setHours(0,0,0,0);
        const end = new Date();
        end.setDate(end.getDate() + 1); 
        end.setHours(23,59,59,999);
        
        // Eleringi originaalaadress
        const eleringUrl = `https://dashboard.elering.ee/api/nps/price?start=${start.toISOString()}&end=${end.toISOString()}`;

        // 1. KATSE: Corsproxy.io
        try {
            console.log("Proovin meetodit 1 (Corsproxy)...");
            const r1 = await fetchWithTimeout('https://corsproxy.io/?' + encodeURIComponent(eleringUrl));
            if (!r1.ok) throw new Error('Viga');
            const d1 = await r1.json();
            if (d1.data && d1.data.ee) {
                success(d1.data.ee);
                return;
            }
        } catch (e) { console.log("Meetod 1 ebaõnnestus."); }

        // 2. KATSE: Allorigins
        try {
            console.log("Proovin meetodit 2 (Allorigins)...");
            const r2 = await fetchWithTimeout(`https://api.allorigins.win/get?url=${encodeURIComponent(eleringUrl)}`);
            if (!r2.ok) throw new Error('Viga');
            const d2 = await r2.json();
            const actualData = JSON.parse(d2.contents);
            if (actualData.data && actualData.data.ee) {
                success(actualData.data.ee);
                return;
            }
        } catch (e) { console.log("Meetod 2 ebaõnnestus."); }

        // 3. KATSE: Codetabs (uus varuvariant)
        try {
            console.log("Proovin meetodit 3 (Codetabs)...");
            const r3 = await fetchWithTimeout(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(eleringUrl)}`);
            if (!r3.ok) throw new Error('Viga');
            const d3 = await r3.json();
            if (d3.data && d3.data.ee) {
                success(d3.data.ee);
                return;
            }
        } catch (e) { console.log("Meetod 3 ebaõnnestus."); }

        // KUI KÕIK EBAÕNNESTUS
        document.getElementById('loading').style.display = 'none';
        select.innerHTML = '<option>Viga andmete laadimisel :(</option>';
        alert("Kahjuks ei saanud Eleringist hindu kätte (kõik vahendajad on maas). Proovi hiljem uuesti või kasuta Fikseeritud paketti.");
    }

    // Abifunktsioon, kui andmed saadi kätte
    function success(data) {
        electricityPrices = data;
        populateTimeSelect();
        document.getElementById('loading').style.display = 'none';
        console.log("Hinnad edukalt laetud!");
    }

    function populateTimeSelect() {
        const select = document.getElementById('startTimeSelect');
        select.innerHTML = '';
        
        const now = new Date();
        now.setMinutes(0, 0, 0);

        let hasFuturePrices = false;

        electricityPrices.forEach(pricePoint => {
            const time = new Date(pricePoint.timestamp * 1000);
            // Näitame ka praegust tundi, mitte ainult tulevikku
            if (time < now && time.getHours() !== now.getHours()) return;
            
            hasFuturePrices = true;

            const pricePerKwh = (pricePoint.price / 10) * VAT;
            const isToday = time.getDate() === now.getDate();
            const dayStr = isToday ? "Täna" : "Homme";
            const hourStr = time.getHours() + ":00";
            
            const option = document.createElement('option');
            option.value = pricePoint.timestamp;
            
            // Visuaalne lisa: näita hinda rippmenüüs
            option.text = `${dayStr} ${hourStr} (${pricePerKwh.toFixed(1)} s/kWh)`;
            
            if (pricePerKwh < 10) option.style.color = "#4ade80"; // Roheline
            else if (pricePerKwh > 30) option.style.color = "#f87171"; // Punane
            
            select.appendChild(option);
        });

        if (!hasFuturePrices) {
             select.innerHTML = '<option>Hinnad tulevad varsti...</option>';
        }
    }

    // --- Ülejäänud nupufunktsioonid jäävad samaks ---

    function setPackageType(type) {
        currentMode = type;
        document.getElementById('tabExchange').className = type === 'exchange' ? 'type-option active' : 'type-option';
        document.getElementById('tabFixed').className = type === 'fixed' ? 'type-option active' : 'type-option';

        if (type === 'exchange') {
            document.getElementById('exchangeGroup').classList.remove('hidden');
            document.getElementById('btnSmart').classList.remove('hidden');
            document.getElementById('fixedGroup').classList.add('hidden');
        } else {
            document.getElementById('exchangeGroup').classList.add('hidden');
            document.getElementById('btnSmart').classList.add('hidden');
            document.getElementById('fixedGroup').classList.remove('hidden');
        }
        document.getElementById('resultArea').style.display = 'none';
        // Peida kohvinupp, kui vahetad paketti
        const coffeeSection = document.getElementById('coffeeSection');
        if(coffeeSection) coffeeSection.classList.add('hidden');
    }

    function calculateCost(isSmart = false) {
        const duration = parseFloat(document.getElementById('duration').value);
        const fixedFees = parseFloat(document.getElementById('fixedFees').value);
        const power = parseFloat(document.getElementById('heaterPower').value);
        
        let totalCost = 0;
        let avgPriceDisp = 0;

        if (currentMode === 'fixed') {
            const userPrice = parseFloat(document.getElementById('userFixedPrice').value);
            if (isNaN(userPrice)) { alert("Sisesta oma elektrihind!"); return; }
            const fullPrice = userPrice + fixedFees;
            totalCost = (fullPrice / 100) * power * duration;
            avgPriceDisp = fullPrice;
            document.getElementById('smartBadge').style.display = 'none';
        } else {
            const startTimestamp = parseInt(document.getElementById('startTimeSelect').value);
            if (!startTimestamp) { alert("Oota hindu või vali Fikseeritud pakett!"); return; }

            const startIndex = electricityPrices.findIndex(p => p.timestamp === startTimestamp);
            let totalPriceSum = 0;

            for (let i = 0; i < Math.ceil(duration); i++) {
                if (startIndex + i >= electricityPrices.length) break;
                let p = electricityPrices[startIndex + i];
                let fullPrice = ((p.price / 10) * VAT) + fixedFees;
                
                let hoursInSlot = 1;
                if (i === Math.ceil(duration) - 1 && duration % 1 !== 0) {
                    hoursInSlot = duration % 1;
                }
                totalCost += (fullPrice / 100) * power * hoursInSlot;
                totalPriceSum += fullPrice * hoursInSlot;
            }
            avgPriceDisp = totalPriceSum / duration;
            document.getElementById('smartBadge').style.display = isSmart ? 'inline-block' : 'none';
        }

        const resultArea = document.getElementById('resultArea');
        resultArea.style.display = 'block';
        document.getElementById('totalCost').innerText = totalCost.toFixed(2) + " €";
        document.getElementById('avgPriceInfo').innerText = 
            `Arvestuslik kWh hind kokku: ${avgPriceDisp.toFixed(1)} s/kWh`;
            
        // Näita kohvinuppu
        const coffeeSection = document.getElementById('coffeeSection');
        if(coffeeSection) coffeeSection.classList.remove('hidden');
    }

    function findCheapestAndSet() {
        if (currentMode !== 'exchange') return;
        const duration = parseFloat(document.getElementById('duration').value);
        const fixedFees = parseFloat(document.getElementById('fixedFees').value);
        
        let bestCost = Infinity;
        let bestTimestamp = null;
        const select = document.getElementById('startTimeSelect');
        const options = Array.from(select.options);

        // Kontrolli, kas hinnad on üldse laetud
        if (options.length === 0 || isNaN(parseInt(options[0].value))) {
            alert("Hinnad pole laetud, ei saa arvutada.");
            return;
        }

        options.forEach(option => {
            let startTimestamp = parseInt(option.value);
            if(!startTimestamp) return;
            let startIndex = electricityPrices.findIndex(p => p.timestamp === startTimestamp);
            let tempCost = 0;
            
            // Kontrollime, kas andmed ulatuvad nii kaugele
            let validCalculation = true;
            for (let i = 0; i < Math.ceil(duration); i++) {
                if (startIndex + i >= electricityPrices.length) {
                    validCalculation = false;
                    break;
                }
                let p = electricityPrices[startIndex + i];
                let fullPrice = ((p.price / 10) * VAT) + fixedFees;
                let hoursInSlot = 1;
                if (i === Math.ceil(duration) - 1 && duration % 1 !== 0) {
                    hoursInSlot = duration % 1;
                }
                tempCost += fullPrice * hoursInSlot;
            }

            if (validCalculation && tempCost < bestCost) {
                bestCost = tempCost;
                bestTimestamp = startTimestamp;
            }
        });

        if (bestTimestamp) {
            select.value = bestTimestamp;
            calculateCost(true);
        } else {
            alert("Ei leidnud sobivat aega (võib-olla andmed lõppevad enne saunatamise lõppu otsa).");
        }
    }

    // Käivita kohe
    fetchPrices();
</script>
