<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaunaMaster Pro âš¡</title>
    <style>
        :root {
            --bg-color: #0f172a; /* SÃ¼gav tumesinine */
            --card-color: #1e293b;
            --text-color: #f8fafc;
            --accent-color: #f59e0b; /* Merevaik/Kuldne */
            --success-color: #10b981; /* Roheline soovituseks */
            --input-bg: #334155;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: var(--card-color);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            max-width: 420px;
            width: 100%;
        }

        h1 {
            font-size: 1.8rem;
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: var(--accent-color);
            text-align: center;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid transparent;
            background-color: var(--input-bg);
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: #475569;
        }

        .btn-group {
            display: gap;
            gap: 10px;
            display: flex;
            flex-direction: column;
        }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, filter 0.2s;
        }

        .btn-calc {
            background-color: var(--accent-color);
            color: #0f172a;
        }
        
        .btn-calc:hover { filter: brightness(1.1); }

        .btn-smart {
            background-color: transparent;
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .btn-smart:hover { background-color: rgba(16, 185, 129, 0.1); }

        button:active { transform: scale(0.97); }

        /* Tulemuste stiil */
        #resultArea {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #334155;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .cost-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-color);
            text-align: center;
            line-height: 1;
            margin: 10px 0;
        }
        
        .cost-label { text-align: center; color: #94a3b8; font-size: 0.9rem; }

        .details {
            background: #0f172a;
            padding: 15px;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #cbd5e1;
            margin-top: 15px;
        }
        
        .loading { text-align: center; color: var(--accent-color); display: none; margin-top: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>SaunaMaster Pro âš¡</h1>
    <div class="subtitle">Live bÃ¶rsihind + Sinu vÃµrgutasu</div>

    <div class="input-group">
        <label>Sessiooni kestvus (tundi)</label>
        <input type="number" id="duration" value="3" step="0.5">
    </div>

    <div class="input-group">
        <label>Lisatasud kokku (vÃµrgutasu + marginaal) senti/kWh</label>
        <input type="number" id="fixedFees" value="7.0" step="0.1">
    </div>

    <div id="pricesData" style="display:none;"></div>

    <div class="btn-group">
        <button class="btn-calc" onclick="calculateNow()">ðŸ”¥ Arvuta praegune kulu</button>
        <button class="btn-smart" onclick="findBestTime()">ðŸŒ± Leia odavaim aeg (24h)</button>
    </div>

    <div id="loading" class="loading">Laen andmeid Eleringist...</div>

    <div id="resultArea">
        <div class="cost-label" id="resultTitle">Hinnanguline kulu:</div>
        <div class="cost-display" id="totalCost">0.00 â‚¬</div>
        <div class="details" id="detailsText"></div>
    </div>
</div>

<script>
    const HEATER_POWER = 6; // kW
    const VAT = 1.22; // KÃ¤ibemaks 22%

    // See funktsioon kÃ¤ivitub kohe lehe laadimisel ja toob hinnad taustal
    let electricityPrices = [];

    async function fetchPrices() {
        document.getElementById('loading').style.display = 'block';
        
        // Leiame tÃ¤nase ja homse kuupÃ¤eva ISO formaadis
        const start = new Date();
        start.setHours(0,0,0,0);
        const end = new Date();
        end.setDate(end.getDate() + 1);
        end.setHours(23,59,59,999);

        // Kodeerime kuupÃ¤evad URLi jaoks
        const startStr = start.toISOString();
        const endStr = end.toISOString();

        try {
            // PÃ¤ris pÃ¤ring Eleringi serverisse
            const response = await fetch(`https://dashboard.elering.ee/api/nps/price?start=${startStr}&end=${endStr}`);
            const data = await response.json();
            
            // Elering annab andmed 'data.ee' all
            if (data.data && data.data.ee) {
                electricityPrices = data.data.ee;
                console.log("Hinnad laetud:", electricityPrices.length, "tundi");
            } else {
                alert("Ei saanud Eleringist andmeid kÃ¤tte.");
            }
        } catch (error) {
            console.error("Viga:", error);
            alert("Viga hindade laadimisel. Kontrolli internetiÃ¼hendust.");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // KÃ¤ivitame andmete laadimise kohe
    fetchPrices();

    function getPriceAtTime(dateObj) {
        // Leiame massiivist hinna, mis vastab antud tunnile
        // Eleringi timestamp on sekundites (UNIX), JS kasutab millisekundeid
        const hourTimestamp = Math.floor(dateObj.getTime() / 1000); 
        
        // Leiame hinna vahemiku (Elering annab tunni alguse timestampi)
        // Kuna timestampid ei pruugi sekundipealt klappida, otsime sama tundi
        const match = electricityPrices.find(p => {
            const priceTime = new Date(p.timestamp * 1000);
            return priceTime.getDate() === dateObj.getDate() && 
                   priceTime.getHours() === dateObj.getHours();
        });

        if (match) {
            // Hind on EUR/MWh. Teeme senti/kWh (jagame 10-ga) ja lisame KM
            return (match.price / 10) * VAT; 
        }
        return null; // Hind puudub
    }

    function calculateNow() {
        if (electricityPrices.length === 0) { alert("Andmed pole veel laetud, oota hetk!"); return; }

        const duration = parseFloat(document.getElementById('duration').value);
        const fixedFees = parseFloat(document.getElementById('fixedFees').value);
        const now = new Date();

        let totalCost = 0;
        let avgPrice = 0;
        let missingData = false;

        // Arvutame kulu tund-tunni haaval
        // Kui kestvus on 2.5h, siis vÃµtame: 1h hinda + 1h hinda + 0.5h hinda
        for (let i = 0; i < Math.ceil(duration); i++) {
            let checkTime = new Date(now.getTime() + i * 60 * 60 * 1000);
            let priceWithVat = getPriceAtTime(checkTime); // Senti/kWh koos KM-ga

            if (priceWithVat === null) { missingData = true; break; }

            // Koguhind = BÃ¶rsihind (KM-ga) + Lisatasud (eeldame, et sisestati juba KM-ga vÃµi ilma, aga lihtsuse mÃµttes liidame otsa)
            // Tegelikult: (BÃ¶rs + Lisatasud) * kW
            let fullPriceCents = priceWithVat + fixedFees;

            // Kui on viimane tund ja see pole tÃ¤istund (nt 0.5h), siis vÃµtame proportsiooni
            let hoursInThisSlot = 1;
            if (i === Math.ceil(duration) - 1 && duration % 1 !== 0) {
                hoursInThisSlot = duration % 1;
            }

            totalCost += (fullPriceCents / 100) * HEATER_POWER * hoursInThisSlot;
            avgPrice += fullPriceCents;
        }

        if (missingData) {
            alert("Ei leidnud hindu kogu perioodiks (ehk lÃ¤heb liiga kaugele tulevikku).");
            return;
        }

        displayResult("Praegune saunakulu", totalCost, 
            `BÃ¶rsihind muutub iga tund.<br>Arvutatud algusega kell ${now.getHours()}:${now.getMinutes() < 10 ? '0'+now.getMinutes() : now.getMinutes()}`);
    }

    function findBestTime() {
        if (electricityPrices.length === 0) { alert("Andmed pole veel laetud!"); return; }
        
        const duration = parseFloat(document.getElementById('duration').value);
        const fixedFees = parseFloat(document.getElementById('fixedFees').value);
        
        let bestCost = Infinity;
        let bestTime = null;
        let bestAvgPrice = 0;

        // Vaatame lÃ¤bi kÃµik saadaval olevad tunnid
        // Lihtsuse mÃµttes vaatame tÃ¤istunde alguspunktidena
        for (let i = 0; i < electricityPrices.length - Math.ceil(duration); i++) {
            let currentStartItem = electricityPrices[i];
            let startTime = new Date(currentStartItem.timestamp * 1000);
            
            // Ã„ra vaata minevikku (v.a kÃ¤imasolev tund)
            if (startTime < new Date().setMinutes(0,0,0)) continue;

            let tempCost = 0;
            // Arvuta selle vÃµimaliku akna kulu
            for (let j = 0; j < Math.ceil(duration); j++) {
                 let p = electricityPrices[i+j];
                 let priceWithVat = (p.price / 10) * VAT;
                 let fullPriceCents = priceWithVat + fixedFees;
                 
                 let hoursInThisSlot = 1;
                 if (j === Math.ceil(duration) - 1 && duration % 1 !== 0) {
                     hoursInThisSlot = duration % 1;
                 }
                 
                 tempCost += (fullPriceCents / 100) * HEATER_POWER * hoursInThisSlot;
            }

            if (tempCost < bestCost) {
                bestCost = tempCost;
                bestTime = startTime;
            }
        }

        if (bestTime) {
             const dayStr = bestTime.getDate() === new Date().getDate() ? "TÃ¤na" : "Homme";
             const timeStr = `${bestTime.getHours()}:00`;
             
             displayResult("Soovituslik aeg ðŸŒ±", bestCost, 
                `Parim aeg on <b>${dayStr} kell ${timeStr}</b>.<br>SÃ¤Ã¤stlikum kui muud ajad!`);
        } else {
            alert("Ei leidnud sobivat aega (andmed otsas).");
        }
    }

    function displayResult(title, cost, details) {
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('resultTitle').innerText = title;
        document.getElementById('totalCost').innerText = cost.toFixed(2) + " â‚¬";
        document.getElementById('detailsText').innerHTML = details;
    }
</script>

</body>
</html>